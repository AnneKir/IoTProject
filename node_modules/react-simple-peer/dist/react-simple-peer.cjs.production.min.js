"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("rxjs"),n=e(require("freeice")),r=e(require("simple-peer")),o=e(require("uid-safe")),i=require("typed-structures"),s=e(require("react")),c=e(require("filter-react-props")),a=require("wasm-flate"),u=function(e){try{return Promise.resolve(new Promise((function(t,n){try{e&&e.on("signal",(function(e){return t(e)}))}catch(e){n(e)}})))}catch(e){return Promise.reject(e)}},m=function(e){try{var t=M.value;if(A.value!==exports.Status.IDLE)return t.joinRequests.stack(e),M.next(t),Promise.resolve();A.next(exports.Status.EMITTING_OFFER);var o={initiator:!0,trickle:!1,config:{iceServers:n()}};return t.model.stream&&(o.stream=t.model.stream),t.peerConnection=new r(o),t.peerConnection.on("stream",(function(t){try{var n=M.value,r=function(){if(n.connections.get(e.peerId)){var r=n.connections.get(e.peerId);return Promise.resolve(t).then((function(t){r.model.stream=t,n.connections.set(e.peerId,r),M.next(n)}))}}();return Promise.resolve(r&&r.then?r.then((function(){})):void 0)}catch(e){return Promise.reject(e)}})),Promise.resolve(u(t.peerConnection)).then((function(n){t.signalData=n,t.emitOfferResponse(e,t.signalData),M.next(t)}))}catch(e){return Promise.reject(e)}},l={id:o.sync(15),peers:{},room:null,roomCreatorId:null,signalData:{},connections:new Map,peerConnection:new r,commands:new Map,model:{connection:new r,stream:null},joinRequests:new i.Stack,clientOffers:new i.Stack,emitJoinRequest:function(){},emitOfferResponse:function(){},emitInitiatorOffers:function(){},emitJoinAck:function(){}};function f(){return(f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function p(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var _=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state={},t}p(t,e);var n=t.prototype;return n.componentDidMount=function(){var e=M.value;e.emitJoinRequest=this.props.join,M.next(e)},n.render=function(){var e=this.props,t=e.join,n=e.children,r=e.room,o=e.onClick;return s.createElement("button",Object.assign({},c(this.props),{onClick:function(e){w(r),t(),o&&o(e)}}),n)},t}(s.Component),v=function(e,t,n){try{try{return e.send(a.deflate_encode_raw(new Uint8Array(Buffer.from(""+M.value.id+t+n)))),Promise.resolve(!0)}catch(e){return console.warn("An error occurred when trying to send data to peer: Failed to reach peer"),Promise.resolve(!1)}}catch(e){return Promise.reject(e)}};function d(e,t){e.on("connect",(function(){try{var n=function(){var t=M.value,n=t.model,r=Array.from(t.connections.keys());return Promise.resolve(v(e,"SYNC_MODEL_DATA_____",JSON.stringify({model:n,peers:r}))).then((function(){}))},r=function(){if(t)return Promise.resolve(v(e,"OPEN_CNTS_AS_INIT___",JSON.stringify(M.value.peers))).then((function(){}))}();return Promise.resolve(r&&r.then?r.then(n):n())}catch(e){return Promise.reject(e)}})),e.on("data",(function(t){e.initiator||0!==M.value.connections.size||A.next(exports.Status.CONNECTING_TO_EXISTING_PEERS),function(e,t){var n=e.substr(0,20),r=e.substr(20,20);if(t.commands.get(r))try{t.commands.get(r)(n,e.substr(40),t)}catch(e){console.warn(e)}}(new TextDecoder("utf-8").decode(a.deflate_decode_raw(t)),M.value),M.next(M.value)}))}var h=function(e,t,o){try{var i=JSON.parse(t),s=function(){if(Object.entries(i).length)return Promise.resolve(function(e,t){try{return Promise.resolve(Promise.all(Object.entries(e).filter((function(e){return e[0]!==t.id})).map((function(e){try{var o={initiator:!0,trickle:!1,config:{iceServers:n()}};t.model.stream&&(o.stream=t.model.stream);var i=new r(o);return d(i,!1),i.on("stream",(function(n){try{var r=function(){if(t.connections.get(e[0]))return Promise.resolve(n).then((function(n){t.connections.get(e[0]).model.stream=n}))}();return Promise.resolve(r&&r.then?r.then((function(){})):void 0)}catch(e){return Promise.reject(e)}})),Promise.resolve(u(i)).then((function(n){e.splice(1,1,n);var r=t.connections.get(e[0]);return t.connections.set(e[0],r||{model:{connection:i,stream:null},peers:[]}),M.next(t),e}))}catch(e){return Promise.reject(e)}})))).then(Object.fromEntries)}catch(e){return Promise.reject(e)}}(i,o)).then((function(e){o.emitInitiatorOffers(e,o.id,o.room)}))}();return Promise.resolve(s&&s.then?s.then((function(){})):void 0)}catch(e){return Promise.reject(e)}};function E(e,t,n){if(n.connections.get(e)){var r=JSON.parse(t),o=n.connections.get(e).model;n.connections.set(e,{peers:r.peers,model:f({},r.model,{connection:o.connection,stream:o.stream})}),M.next(n)}}var S=function(e,t,o){try{var i=M.value;0===i.connections.size&&A.next(exports.Status.RECEIVING_RESPONSE_ACCESS);var s={initiator:!1,trickle:!1,config:{iceServers:n()}};return i.model.stream&&(s.stream=i.model.stream),i.peerConnection=new r(s),i.peerConnection.on("stream",(function(e){t&&i.connections.set(t,{model:{connection:i.peerConnection,stream:e},peers:[]})})),i.peerConnection.signal(e),Promise.resolve(u(i.peerConnection)).then((function(e){0===i.connections.size&&A.next(exports.Status.JOINING_SESSION),i.emitJoinAck(e,o,t,i.id),d(i.peerConnection,!1),M.next(i)}))}catch(e){return Promise.reject(e)}};function I(e,t,n,r){var o=M.value;if(n){d(o.peerConnection,!0);var i=o.connections.get(r);o.connections.set(r,i||{model:{connection:o.peerConnection,stream:null},peers:[]}),M.next(o)}if(t&&o.connections.get(r)){var s=o.connections.get(r);d(s.model.connection,!1),o.peerConnection=s.model.connection,M.next(o)}o.peerConnection.on("error",(function(e){try{return"ERR_SET_REMOTE_DESCRIPTION"===e.code?(console.warn("Encountered an error while trying to signal incoming offer, retrying"),setTimeout((function(){return Promise.resolve(function e(){try{var t=function(t){(!n||n&&!t)&&setTimeout((function(){return Promise.resolve(e())}),Math.ceil(1e3*Math.random()))},n=Array.from(M.value.connections.values()).find((function(e){return e.peers.includes(r)}));return Promise.resolve(n&&n?Promise.resolve(!n||n&&v(n.model.connection,"TELL_HIM_TO_RETRY___",r)).then(t):t(!n||n&&v(n.model.connection,"TELL_HIM_TO_RETRY___",r)))}catch(e){return Promise.reject(e)}}())}),Math.ceil(1e3*Math.random())),Promise.resolve()):Promise.resolve()}catch(e){return Promise.reject(e)}})),o.peerConnection.signal(e.offer),o.peers=e.peers,A.next(exports.Status.IDLE),M.next(o)}var O=function(e,t,o){try{var i=JSON.parse(t),s=JSON.parse(i.offer),c=i.id,a={initiator:!1,trickle:!1,config:{iceServers:n()}};o.model.stream&&(a.stream=o.model.stream);var m=new r(a);return m.signal(s),Promise.resolve(u(o.peerConnection)).then((function(e){v(m,"NON_INITIATOR_OFFER_",JSON.stringify({id:o.id,offer:e})),d(m,!1);var t=o.connections.get(c);o.connections.set(c,t||{model:{connection:m,stream:null},peers:[]})}))}catch(e){return Promise.reject(e)}},P=function(e,t,n){try{var r=JSON.parse(t),o=r.offer,i=r.id;d(n.peerConnection,!0);var s=n.connections.get(i);return n.connections.set(i,s||{model:{connection:n.peerConnection,stream:null},peers:[]}),n.peerConnection.signal(o),M.next(n),Promise.resolve()}catch(e){return Promise.reject(e)}},N=function(e,t,n){try{var r=n.connections.get(t),o=function(){if(r)return Promise.resolve(v(r.model.connection,"RETRY_______________")).then((function(){}))}();return Promise.resolve(o&&o.then?o.then((function(){})):void 0)}catch(e){return Promise.reject(e)}};function C(e,t,n){M.next(l),setTimeout((function(){return n.emitJoinRequest()}),Math.ceil(1e3*Math.random()))}var R,g=function(e){function t(t){var n;(n=e.call(this,t)||this).state={};var r=n.props,o=r.onJoinResponse,i=r.onClientOffer,s=r.onOfferRequest,c=r.onLeaving,a=r.emitOfferResponse,u=r.emitInitiatorOffers,l=r.emitJoinAck,f=M.value;return f.commands.set("OPEN_CNTS_AS_INIT___",h),f.commands.set("SYNC_MODEL_DATA_____",E),f.commands.set("INITIATOR_OFFER_____",O),f.commands.set("NON_INITIATOR_OFFER_",P),f.commands.set("TELL_HIM_TO_RETRY___",N),f.commands.set("RETRY_______________",C),f.emitOfferResponse=a,f.emitInitiatorOffers=u,f.emitJoinAck=l,s(m),o(S),i(I),c((function(){return console.log("TODO: Implement processLeaving")})),M.next(f),n}return p(t,e),t.prototype.render=function(){return this.props.children||s.createElement(s.Fragment,null)},t}(s.Component),T=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state={connections:[]},t}p(t,e);var n=t.prototype;return n.componentDidMount=function(){var e=this;M.subscribe((function(t){e.setState({connections:Array.from(t.connections).map((function(e){return e[1].model}))})}))},n.render=function(){return(0,this.props.children)(this.state.connections)||s.createElement(s.Fragment,null)},t}(s.Component),y={IDLE:"Waiting for peers",EMITTING_OFFER:"Emitting offer",REQUESTING_ACCESS:"Requesting access",RECEIVING_RESPONSE_ACCESS:"Receiving response access",CONNECTING_TO_EXISTING_PEERS:"Connecting to existing peers",JOINING_SESSION:"Joining session"},x=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state={value:""},t}p(t,e);var n=t.prototype;return n.componentDidMount=function(){var e=this;A.subscribe((function(t){try{return e.setState({value:y[t]}),Promise.resolve()}catch(e){return Promise.reject(e)}}))},n.render=function(){return s.createElement(s.Fragment,null,this.state.value)},t}(s.Component),j=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state={stream:null},t.video=document.createElement("video"),t}p(t,e);var n=t.prototype;return n.componentDidUpdate=function(){try{var e=this;return Promise.resolve(e.props.peer.stream).then((function(t){e.video.srcObject=t}))}catch(e){return Promise.reject(e)}},n.render=function(){var e=this;return s.createElement("video",Object.assign({},c(this.props),{autoPlay:!0,muted:!0,ref:function(t){e.video=t}}))},t}(s.Component);(R=exports.Status||(exports.Status={})).IDLE="IDLE",R.EMITTING_OFFER="EMITTING_OFFER",R.REQUESTING_ACCESS="REQUESTING_ACCESS",R.RECEIVING_RESPONSE_ACCESS="RECEIVING_RESPONSE_ACCESS",R.CONNECTING_TO_EXISTING_PEERS="CONNECTING_TO_EXISTING_PEERS",R.JOINING_SESSION="JOINING_SESSION";var A=new t.BehaviorSubject(exports.Status.IDLE),M=new t.BehaviorSubject(l);function w(e){var t=M.value;t.room=e,M.next(t)}A.subscribe((function(e){try{if(e===exports.Status.IDLE&&M.value.joinRequests.length()){var t=M.value;console.log(t.joinRequests.length());var n=t.joinRequests.unstack();console.log(t.joinRequests.length()),M.next(t),setTimeout((function(){try{return Promise.resolve(m(n))}catch(e){return Promise.reject(e)}}),Math.ceil(1e3*Math.random()))}return Promise.resolve()}catch(e){return Promise.reject(e)}})),exports.ClientOffer=function(e,t){this.offer=e,this.peers=t},exports.JoinRequest=function(e,t){this.roomId=e,this.peerId=t},exports.JoinRoomButton=_,exports.PeerVideo=j,exports.Peers=T,exports.ReactSimplePeerState=M,exports.ReactSimplePeerStatusState=A,exports.Setup=g,exports.State=x,exports.getId=function(){return M.value.id},exports.setModel=function(e){var t=M.value;t.model=e,M.next(t)},exports.setRoom=w;
//# sourceMappingURL=react-simple-peer.cjs.production.min.js.map
